<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飞书表格转部署 YAML - 专业版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;600&display=swap');

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: #f3f4f6;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
        }
    </style>
</head>

<body class="min-h-screen py-8 px-4">
    <div class="max-w-6xl mx-auto">
        <!-- 头部 -->
        <header class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">飞书表格转 YAML <span
                        class="text-blue-600 text-sm ml-2 font-normal">v2.0 增强版</span></h1>
                <p class="text-gray-500 text-sm mt-1">支持直接粘贴飞书/Excel/Numbers 带有格式的单元格数据</p>
            </div>
            <div class="flex gap-2">
                <button onclick="clearAll()"
                    class="px-4 py-2 text-sm text-gray-600 hover:text-red-600 transition-colors">清空重置</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 输入区域 -->
            <div class="glass p-5 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                        <span class="w-2 h-2 bg-blue-500 rounded-full"></span> 粘贴数据源
                    </span>
                    <span id="rowCount" class="text-xs text-gray-400">待输入...</span>
                </div>
                <div class="relative group">
                    <textarea id="inputArea" placeholder="在此处 Ctrl+V 粘贴飞书表格内容..."
                        class="w-full h-[500px] p-4 text-sm mono border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all bg-white"></textarea>
                </div>
            </div>

            <!-- 输出区域 -->
            <div class="glass p-5 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full"></span> YAML 结果
                    </span>
                    <button onclick="copyYaml()" id="copyBtn"
                        class="text-xs px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-md font-medium transition-all">
                        复制 YAML
                    </button>
                </div>
                <pre id="outputArea"
                    class="w-full h-[500px] p-4 text-sm mono bg-gray-900 text-blue-300 rounded-lg overflow-auto border border-gray-800 leading-relaxed"></pre>
            </div>
        </div>

        <!-- 逻辑说明 -->
        <footer
            class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg text-xs text-gray-500 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <strong>1. 复制范围：</strong> 选中包含“部署分组”、“机器ip”、“应用名”表头的区域。
            </div>
            <div>
                <strong>2. 自动转换：</strong> 程序会自动过滤多余引号、Tab 键和首尾空格。
            </div>
            <div>
                <strong>3. 结构说明：</strong> 相同部署分组的应用会自动合并到一个数组下。
            </div>
        </footer>
    </div>

    <script>
        const inputArea = document.getElementById('inputArea');
        const outputArea = document.getElementById('outputArea');
        const rowCount = document.getElementById('rowCount');

        // 监听粘贴事件，处理飞书特有的格式
        inputArea.addEventListener('paste', (e) => {
            // 稍等片刻待 DOM 更新
            setTimeout(() => {
                processData(inputArea.value);
            }, 10);
        });

        // 也可以手动修改触发
        inputArea.addEventListener('input', () => {
            processData(inputArea.value);
        });

        function processData(rawText) {
            if (!rawText.trim()) {
                outputArea.textContent = '';
                rowCount.textContent = '待输入...';
                return;
            }

            try {
                // 1. 将数据拆分为行
                // 飞书表格复制出的数据通常以 \n 或 \r\n 分隔行
                const lines = rawText.split(/\r?\n/).filter(line => line.trim() !== '');

                // 2. 将行拆分为单元格 (飞书复制的核心是 \t 制表符)
                const tableData = lines.map(line => {
                    return line.split('\t').map(cell => {
                        // 清洗单元格：去除前后空格、去除首尾可能存在的引号
                        return cell.trim().replace(/^"(.*)"$/, '$1');
                    });
                });

                if (tableData.length < 2) {
                    throw new Error('未检测到有效数据行');
                }

                const headers = tableData[0];
                const rows = tableData.slice(1);

                // 3. 动态定位表头索引 (增加容错)
                const findIndex = (names) => headers.findIndex(h => names.some(n => h.includes(n)));

                const idxGroup = findIndex(['部署分组', '分组', 'group']);
                const idxIp = findIndex(['机器ip', 'ip', 'IP', 'host']);
                const idxAppName = findIndex(['应用名', '应用', 'app']);

                if (idxGroup === -1 || idxIp === -1 || idxAppName === -1) {
                    throw new Error('缺少必要表头：部署分组、机器ip 或 应用名');
                }

                // 4. 按分组聚合数据
                const groupMap = new Map();

                rows.forEach(row => {
                    // 确保这一行有足够的数据
                    if (row.length <= Math.max(idxGroup, idxIp, idxAppName)) return;

                    const groupName = row[idxGroup];
                    const targetIp = row[idxIp];
                    const appName = row[idxAppName];

                    if (!groupName || !targetIp) return; // 跳过无效行

                    if (!groupMap.has(groupName)) {
                        groupMap.set(groupName, []);
                    }
                    groupMap.get(groupName).push({
                        app_name: appName,
                        target_ip: targetIp
                    });
                });

                // 5. 生成对象结构
                const result = {
                    deploy_groups: Array.from(groupMap).map(([name, apps]) => ({
                        name: name,
                        apps: apps
                    }))
                };

                // 6. 渲染 YAML
                const yamlOutput = jsyaml.dump(result, {
                    indent: 2,
                    noArrayIndent: false,
                    skipInvalid: true
                });

                outputArea.textContent = yamlOutput;
                rowCount.textContent = `成功处理 ${rows.length} 行数据`;

            } catch (err) {
                outputArea.textContent = `解析错误: ${err.message}\n\n请确保复制的内容包含表头，并尝试重新粘贴。`;
                rowCount.textContent = '错误';
            }
        }

        function copyYaml() {
            const content = outputArea.textContent;
            if (!content || content.startsWith('解析错误')) return;

            navigator.clipboard.writeText(content).then(() => {
                const btn = document.getElementById('copyBtn');
                const oldText = btn.innerText;
                btn.innerText = '✅ 已复制';
                btn.classList.replace('bg-blue-50', 'bg-green-100');
                btn.classList.replace('text-blue-600', 'text-green-700');

                setTimeout(() => {
                    btn.innerText = oldText;
                    btn.classList.replace('bg-green-100', 'bg-blue-50');
                    btn.classList.replace('text-green-700', 'text-blue-600');
                }, 2000);
            });
        }

        function clearAll() {
            inputArea.value = '';
            outputArea.textContent = '';
            rowCount.textContent = '待输入...';
        }
    </script>
</body>

</html>