<!DOCTYPE html>
<html lang="zh-CN" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeployYAML Pro - 双向转换工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;600&display=swap');

        :root {
            color-scheme: dark;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* 滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        /* 编辑状态 */
        [contenteditable]:focus {
            outline: none;
            background: #1e293b;
            box-shadow: inset 0 0 0 1px #6366f1;
        }

        .active-tab {
            background-color: #1e293b;
            color: #818cf8;
            border-bottom: 2px solid #6366f1;
        }

        .panel-container {
            height: calc(100vh - 64px);
        }

        /* 这里的 textarea 模拟代码编辑器 */
        #yamlEditor {
            scrollbar-gutter: stable;
            caret-color: #6366f1;
        }
    </style>
</head>

<body class="flex flex-col">

    <!-- Header -->
    <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900 shrink-0 z-10">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                </svg>
            </div>
            <h1 class="text-lg font-semibold tracking-tight">DeployYAML <span
                    class="text-slate-500 font-normal">Bi-Directional</span></h1>
        </div>

        <div class="flex items-center gap-2">
            <span id="msgTag"
                class="text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-400 opacity-0 transition-opacity">已同步</span>
            <button onclick="copyYaml()"
                class="bg-slate-800 hover:bg-slate-700 text-slate-200 text-sm px-4 py-2 rounded-lg transition-all flex items-center gap-2">
                复制 YAML
            </button>
            <button onclick="downloadYaml()"
                class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm px-4 py-2 rounded-lg transition-all flex items-center gap-2">
                下载 .yml
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex flex-1 overflow-hidden">

        <!-- Left: Input / Table (Data Source) -->
        <section class="w-1/2 border-r border-slate-800 flex flex-col bg-slate-900/30">
            <div class="flex bg-slate-900 border-b border-slate-800 shrink-0">
                <button id="tabTable" onclick="switchView('table')"
                    class="px-6 py-3 text-sm font-medium active-tab transition-all">表格编辑</button>
                <button id="tabText" onclick="switchView('text')"
                    class="px-6 py-3 text-sm font-medium text-slate-400 hover:text-slate-200 transition-all">原始文本</button>
            </div>

            <div class="flex-1 relative overflow-hidden">
                <!-- Table View -->
                <div id="tableView" class="absolute inset-0 overflow-auto p-0">
                    <table class="w-full text-left border-collapse">
                        <thead class="sticky top-0 bg-slate-900 shadow-sm z-10">
                            <tr id="tableHead" class="text-slate-500 text-xs uppercase border-b border-slate-800">
                                <!-- Dynamic -->
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="text-sm divide-y divide-slate-800/50 text-slate-300">
                            <!-- Dynamic -->
                        </tbody>
                    </table>
                    <div id="emptyState" class="flex flex-col items-center justify-center h-64 text-slate-600">
                        <p class="text-sm italic">等待粘贴飞书数据...</p>
                    </div>
                </div>

                <!-- Text View -->
                <div id="textView" class="absolute inset-0 hidden">
                    <textarea id="inputArea" placeholder="在此粘贴飞书表格数据..."
                        class="w-full h-full p-6 bg-transparent mono text-sm text-slate-400 outline-none resize-none leading-relaxed"></textarea>
                </div>
            </div>
        </section>

        <!-- Right: YAML Editor -->
        <section class="w-1/2 flex flex-col bg-[#0b1120]">
            <div class="px-6 py-2 bg-slate-900/80 border-b border-slate-800 flex items-center justify-between shrink-0">
                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">YAML Editor</span>
                <button onclick="syncYamlToTable()"
                    class="text-xs text-indigo-400 hover:text-indigo-300 flex items-center gap-1.5 py-1 px-2 rounded hover:bg-indigo-500/10 transition-all"
                    title="将修改后的 YAML 反向同步到左侧表格">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"></path>
                    </svg>
                    反向同步至表格
                </button>
            </div>

            <textarea id="yamlEditor" spellcheck="false"
                class="flex-1 w-full p-8 bg-transparent mono text-sm text-cyan-400 outline-none resize-none leading-relaxed border-none focus:ring-0"></textarea>
        </section>
    </main>

    <script>
        const inputArea = document.getElementById('inputArea');
        const yamlEditor = document.getElementById('yamlEditor');
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        const emptyState = document.getElementById('emptyState');
        const msgTag = document.getElementById('msgTag');

        // 数据模型：[ [headers...], [row1...], [row2...] ]
        let dataState = [];

        // --- 1. 监听左侧粘贴/输入 ---
        inputArea.addEventListener('input', () => {
            parseFromText(inputArea.value);
            syncToYaml();
        });

        // --- 2. 解析逻辑 (Text -> State) ---
        function parseFromText(text) {
            const raw = text.trim();
            if (!raw) {
                dataState = [];
                renderTable();
                return;
            }
            const lines = raw.split(/\r?\n/).filter(l => l.trim() !== '');
            dataState = lines.map(line => line.split('\t').map(cell => cell.trim().replace(/^"(.*)"$/, '$1')));
            renderTable();
        }

        // --- 3. 渲染左侧表格 ---
        function renderTable() {
            if (dataState.length === 0) {
                tableHead.innerHTML = ''; tableBody.innerHTML = '';
                emptyState.style.display = 'flex';
                return;
            }
            emptyState.style.display = 'none';

            const [headers, ...rows] = dataState;
            tableHead.innerHTML = headers.map(h => `<th class="px-6 py-3 font-semibold">${h}</th>`).join('');
            tableBody.innerHTML = rows.map((row, rIdx) => `
                <tr class="hover:bg-slate-800/30">
                    ${row.map((cell, cIdx) => `
                        <td contenteditable="true" 
                            oninput="updateDataState(${rIdx + 1}, ${cIdx}, this.innerText)"
                            class="px-6 py-3 border-b border-slate-800/50 outline-none text-slate-400 focus:text-white"
                        >${cell}</td>
                    `).join('')}
                </tr>
            `).join('');
        }

        // --- 4. 表格编辑同步 ---
        function updateDataState(r, c, val) {
            dataState[r][c] = val.trim();
            // 同步回文本域
            inputArea.value = dataState.map(row => row.join('\t')).join('\n');
            syncToYaml();
        }

        // --- 5. 正向同步 (State -> YAML) ---
        function syncToYaml() {
            if (dataState.length < 2) { yamlEditor.value = ""; return; }
            const headers = dataState[0];
            const rows = dataState.slice(1);

            const idxGroup = headers.indexOf('部署分组');
            const idxIp = headers.indexOf('机器ip');
            const idxApp = headers.indexOf('应用名');

            if (idxGroup === -1 || idxIp === -1 || idxApp === -1) {
                yamlEditor.value = "# 错误: 表头必须包含 [部署分组, 机器ip, 应用名]";
                return;
            }

            const groups = new Map();
            rows.forEach(row => {
                const gName = row[idxGroup];
                if (!gName) return;
                if (!groups.has(gName)) groups.set(gName, []);
                groups.get(gName).push({
                    app_name: row[idxApp] || "",
                    target_ip: row[idxIp] || ""
                });
            });

            const obj = {
                deploy_groups: Array.from(groups).map(([name, apps]) => ({ name, apps }))
            };

            yamlEditor.value = jsyaml.dump(obj, { indent: 2, lineWidth: -1 });
            showStatus("已更新 YAML");
        }

        // --- 6. 逆向同步 (YAML -> State/Table) ---
        function syncYamlToTable() {
            const yamlText = yamlEditor.value.trim();
            if (!yamlText) return;

            try {
                const doc = jsyaml.load(yamlText);
                if (!doc || !doc.deploy_groups || !Array.isArray(doc.deploy_groups)) {
                    throw new Error("YAML 格式不符合 deploy_groups 结构");
                }

                // 重建 dataState
                const newHeaders = ['部署分组', '机器ip', '应用名'];
                const newRows = [];

                doc.deploy_groups.forEach(group => {
                    const gName = group.name || "未命名分组";
                    if (group.apps && Array.isArray(group.apps)) {
                        group.apps.forEach(app => {
                            newRows.push([gName, app.target_ip || "", app.app_name || ""]);
                        });
                    }
                });

                dataState = [newHeaders, ...newRows];

                // 同步 UI
                inputArea.value = dataState.map(row => row.join('\t')).join('\n');
                renderTable();
                showStatus("已从 YAML 反向同步数据");
            } catch (e) {
                alert("逆向同步失败，请检查 YAML 格式: " + e.message);
            }
        }

        // --- 辅助功能 ---
        function switchView(mode) {
            const vTable = document.getElementById('tableView');
            const vText = document.getElementById('textView');
            const tTable = document.getElementById('tabTable');
            const tText = document.getElementById('tabText');

            if (mode === 'table') {
                vTable.classList.remove('hidden'); vText.classList.add('hidden');
                tTable.classList.add('active-tab'); tText.classList.remove('active-tab');
            } else {
                vTable.classList.add('hidden'); vText.classList.remove('hidden');
                tText.classList.add('active-tab'); tTable.classList.remove('active-tab');
            }
        }

        function showStatus(text) {
            msgTag.innerText = text;
            msgTag.style.opacity = 1;
            setTimeout(() => msgTag.style.opacity = 0, 2000);
        }

        function copyYaml() {
            navigator.clipboard.writeText(yamlEditor.value).then(() => showStatus("已复制到剪贴板"));
        }

        function downloadYaml() {
            const blob = new Blob([yamlEditor.value], { type: 'text/yaml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'deploy.yml';
            a.click();
        }
    </script>
</body>

</html>