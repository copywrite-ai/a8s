- name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | Load config"
  set_fact:
    current_app: "{{ app_definitions[item_plan.app_name] }}"
    healthcheck_config: "{{ current_app.healthcheck | default({}) }}"

- name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | DEBUG | Check Connection Method"
  debug:
    msg: 
      - "Target: {{ item_plan.target_ip }}"
      - "Connection: {{ ansible_connection | default('ssh (default)') }}"
      - "Inventory Hostname: {{ inventory_hostname }}"
  delegate_to: "{{ item_plan.target_ip }}"
  vars:
    # Force gather connection var from delegated host context
    ansible_connection: "{{ hostvars[item_plan.target_ip].ansible_connection | default('ssh (default)') }}"

# 2. 物料分发
- name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | Sync directory materials using modular task"
  include_tasks: sync_v2.yml
  vars:
    sync_src: "{{ item.src }}"
    sync_dest: "{{ item.dest }}"
    sync_owner: "{{ item.owner | default('root') }}"
    sync_group: "{{ item.group | default('root') }}"
    sync_mode: "{{ item.mode | default('0755') }}"
    delegate_host: "{{ item_plan.target_ip }}"
  when: 
    - current_app.materials is defined
    - item.type == 'archive_dir'
  loop: "{{ current_app.materials | default([]) }}"
  loop_control:
    loop_var: item

# 2.1 单文件物料分发
- name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | Ensure parent directory exists for config files"
  file:
    path: "{{ item.dest | dirname }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: '0755'
  when: 
    - current_app.materials is defined
    - item.type == 'file'
  loop: "{{ current_app.materials | default([]) }}"
  delegate_to: "{{ item_plan.target_ip }}"

- name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | Distribute config files"
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('0644') }}"
    force: yes
    backup: yes
    remote_src: false
  when: 
    - current_app.materials is defined
    - item.type == 'file'
  loop: "{{ current_app.materials | default([]) }}"
  delegate_to: "{{ item_plan.target_ip }}"

# 3. 准备启动命令 (支持多行port和volume)
- name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | Prepare Run Command"
  set_fact:
    final_run_cmd: >-
      {% if current_app.raw_command is defined %}
        {{ current_app.raw_command | regex_replace('\n', ' ') }}
      {% else %}
        {# --- 自动拼接逻辑开始 --- #}
        docker run -d 
        --name {{ item_plan.app_name }} 
        --restart always 
        {# 多ports支持 #}
        {% if current_app.ports is defined %}
          {% for port in current_app.ports %}
        -p {{ port }}
          {% endfor %}
        {% endif %}
        {# 多volumes支持 #}
        {% for volume in current_app.volumes | default([]) %}
        -v {{ volume }} 
        {% endfor %}
        {# 环境变量 #}
        {% if current_app.env is defined %}
          {% for k,v in current_app.env.items() %}
        -e {{ k }}='{{ v }}' 
          {% endfor %}
        {% endif %}
        {# 多env_file支持 #}
        {% for env in current_app.env_file | default([]) %}
        --env-file {{ env }} 
        {% endfor %}
        {{ current_app.image }}
        {# --- 自动拼接逻辑结束 --- #}
      {% endif %}

# 4. 精确替换续行符（仅处理 \\ 后跟空格的模式）
- name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | Flatten Command String"
  set_fact:
    final_run_cmd: "{{ final_run_cmd | regex_replace('\\\\s+', ' ') }}"

# 5. 打印最终命令 (调试确认)
- name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | DEBUG | Command Preview"
  debug:
    msg: "Executing: {{ final_run_cmd }}"

# 6. 清理旧容器
- name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | Cleanup old container"
  shell: "docker rm -f {{ item_plan.app_name }} || true"
  delegate_to: "{{ item_plan.target_ip }}"
  ignore_errors: true 

# 7. 执行启动
- name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | Run Container"
  shell: "{{ final_run_cmd }}"
  delegate_to: "{{ item_plan.target_ip }}"
