- name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | Load config"
  set_fact:
    current_app: "{{ app_definitions[item_plan.app_name] }}"
    app_type: "{{ app_definitions[item_plan.app_name].app_type | default('docker') }}"
    healthcheck_config: "{{ current_app.healthcheck | default({}) }}"
    skip_deploy: false

# ==========================================
# Phase: Docker Deployment Logic
# ==========================================
- block:
  # 2. 物料分发
  - name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | Sync materials"
    include_tasks: sync_v2.yml
    vars:
      sync_src: "{{ item.src }}"
      sync_dest: "{{ item.dest }}"
      delegate_host: "{{ item_plan.target_ip }}"
    when: current_app.materials is defined and item.type == 'archive_dir'
    loop: "{{ current_app.materials | default([]) }}"
    loop_control:
      loop_var: item

  - name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | Prepare Run Command"
    set_fact:
      final_run_cmd: |
        {% if current_app.raw_command is defined %}
          {{ current_app.raw_command }}
        {% else %}
          docker run -d --name {{ item_plan.app_name }} --restart always 
          {% for port in current_app.ports | default([]) %}-p {{ port }} {% endfor %}
          {% for volume in current_app.volumes | default([]) %}-v {{ volume }} {% endfor %}
          {% for k,v in current_app.env.items() | default({}) %}-e {{ k }}='{{ v }}' {% endfor %}
          {{ current_app.image }}
        {% endif %}

  # 4. 鲁棒的命令平铺 (SRE 增强)
  # 只平铺带 \ 的续行，保留真正的换行符以支持多条命令执行 (Script Mode)
  - name: "Robust Flatten and Compress Command String"
    set_fact:
      final_run_cmd: "{{ final_run_cmd | regex_replace('\\\\\\s*\\n', ' ') | trim }}"

  # 4. 幂等性检查 (SRE 增强)
  - name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | Check Idempotency"
    shell: |
      if docker inspect {{ item_plan.app_name }} >/dev/null 2>&1; then
        current_image=$(docker inspect --format='{{ '{{' }}.Image{{ '}}' }}' {{ item_plan.app_name }} | sed 's/sha256://' | cut -c 1-12)
        target_image_id=$(docker inspect --format='{{ '{{' }}.Id{{ '}}' }}' {{ current_app.image }} 2>/dev/null | sed 's/sha256://' | cut -c 1-12 || echo "unknown")
        status=$(docker inspect --format='{{ '{{' }}.State.Status{{ '}}' }}' {{ item_plan.app_name }})
        
        if [ "$current_image" = "$target_image_id" ] && [ "$status" = "running" ]; then
          echo "match"
        else
          echo "mismatch"
        fi
      else
        echo "not_exists"
      fi
    register: idempotency_check
    delegate_to: "{{ item_plan.target_ip }}"
    changed_when: false
    when: current_app.image is defined

  - name: "Set Skip Deploy Fact"
    set_fact:
      skip_deploy: true
    when: idempotency_check.stdout | default('') == "match"

  - name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | DEBUG | skip_deploy={{ skip_deploy }}"
    debug:
      msg: "Container already running with correct image. Skipping redeploy."
    when: skip_deploy

  # 6. 清理与启动 (仅在需要时执行)
  - name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | Cleanup old container"
    shell: "docker rm -f {{ item_plan.app_name }} || true"
    delegate_to: "{{ item_plan.target_ip }}"
    when: not skip_deploy

  - name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | Run Container"
    shell: "{{ final_run_cmd }}"
    delegate_to: "{{ item_plan.target_ip }}"
    when: not skip_deploy

  when: app_type == 'docker'

# ==========================================
# Phase: CMD/Binary Execution Logic
# ==========================================
- block:
  - name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | Run Command"
    shell: "{{ current_app.command }}"
    delegate_to: "{{ item_plan.target_ip }}"
    register: cmd_result

  - name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ item_plan.target_ip }} | {{ item_plan.app_name }} | DEBUG | Command Output"
    debug:
      msg: "Command exited with {{ cmd_result.rc }}. Output: {{ cmd_result.stdout }}"

  when: app_type == 'cmd'