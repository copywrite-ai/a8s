---
- name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ delegate_host }} | {{ app_name }} | HealthCheck | Check if health status is available"
  shell: |
    # 直接尝试获取健康状态，如果命令成功且有输出，说明有健康检查
    health_status=$(docker inspect --format='{{ '{{' }}.State.Health.Status{{ '}}' }}' {{ app_name }} 2>/dev/null || echo "no_healthcheck")
    
    if [ "$health_status" = "starting" ] || [ "$health_status" = "healthy" ] || [ "$health_status" = "unhealthy" ]; then
      echo "has_healthcheck"
    else
      echo "no_healthcheck"
    fi
  register: healthcheck_type
  delegate_to: "{{ delegate_host }}"
  changed_when: false

- name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ delegate_host }} | {{ app_name }} | DEBUG | 显示健康检查判断结果"
  debug:
    msg: 
      - "健康状态值: '{{ healthcheck_type.stdout }}'"
      - "判断结果: {{ healthcheck_type.stdout_lines[-1] }}"
  delegate_to: "{{ delegate_host }}"
  when: debug_mode | default(false)

- name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ delegate_host }} | {{ app_name }} | HealthCheck | Wait for container with healthcheck"
  shell: "docker inspect --format='{{ '{{' }}.State.Health.Status{{ '}}' }}' {{ app_name }}"
  register: health_status
  until: health_status.stdout == "healthy"
  retries: "{{ retries | default(30) }}"
  delay: "{{ interval | default(5) }}"
  delegate_to: "{{ delegate_host }}"
  when: healthcheck_type.stdout_lines[-1] == "has_healthcheck"

- name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ delegate_host }} | {{ app_name }} | HealthCheck | Wait for one-time container to complete"
  shell: |
    if docker inspect {{ app_name }} >/dev/null 2>&1; then
      status=$(docker inspect --format='{{ '{{' }}.State.Status{{ '}}' }}' {{ app_name }})
      exit_code=$(docker inspect --format='{{ '{{' }}.State.ExitCode{{ '}}' }}' {{ app_name }})
      [ "$status" = "exited" ] && [ "$exit_code" -eq 0 ] && echo "success" || echo "waiting"
    else
      echo "waiting"
    fi
  register: container_status
  until: container_status.stdout == "success"
  retries: "{{ retries | default(30) }}"
  delay: "{{ interval | default(5) }}"
  delegate_to: "{{ delegate_host }}"
  when: healthcheck_type.stdout_lines[-1] == "no_healthcheck"
