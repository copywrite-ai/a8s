# ==========================================
# Phase: Variable Reset (Security)
# ==========================================
- name: "HealthCheck | Reset app-specific facts"
  set_fact:
    container_initial_status: {}
    healthcheck_type: {}
    container_status: {}

# ==========================================
# Phase: Docker Health Check Logic
# ==========================================
- block:
  # 首先检查容器是否存在及其状态
  - name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ delegate_host }} | {{ app_name }} | HealthCheck | Check container existence and status"
    shell: |
      if docker inspect {{ app_name }} >/dev/null 2>&1; then
        status=$(docker inspect --format='{{ '{{' }}.State.Status{{ '}}' }}' {{ app_name }})
        image_id=$(docker inspect --format='{{ '{{' }}.Image{{ '}}' }}' {{ app_name }})
        image_short_id=$(echo "$image_id" | cut -c 1-19)
        
        if [ "$status" = "exited" ]; then
          exit_code=$(docker inspect --format='{{ '{{' }}.State.ExitCode{{ '}}' }}' {{ app_name }})
          if [ "$exit_code" -eq 0 ]; then
            echo "already_exited_success|$image_short_id"
          else
            echo "already_exited_failed|$image_short_id|$exit_code"
          fi
        elif [ "$status" = "running" ]; then
          echo "already_running|$image_short_id"
        else
          echo "exists_other_status|$image_short_id|$status"
        fi
      else
        echo "not_exists"
      fi
    register: container_initial_status
    delegate_to: "{{ delegate_host }}"
    changed_when: false

  - name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ delegate_host }} | {{ app_name }} | DEBUG | Container Initial Status"
    debug:
      msg: "container_initial_status: '{{ container_initial_status.stdout }}'"
    delegate_to: "{{ delegate_host }}"
    when: debug_mode | default(false)

  # 如果容器已经成功退出，则跳过健康检查
  - name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ delegate_host }} | {{ app_name }} | HealthCheck | Skip if already successful"
    debug:
      msg: "Container {{ app_name }} has already exited successfully. Skipping health checks."
    delegate_to: "{{ delegate_host }}"
    when: (container_initial_status.stdout | default('')).startswith("already_exited_success")

  # 只对非成功退出的容器执行健康检查
  - block:
    - name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ delegate_host }} | {{ app_name }} | HealthCheck | Check if health status is available"
      shell: |
        health_status=$(docker inspect --format='{{ '{{' }}.State.Health.Status{{ '}}' }}' {{ app_name }} 2>/dev/null || echo "no_healthcheck")
        if [ "$health_status" = "starting" ] || [ "$health_status" = "healthy" ] || [ "$health_status" = "unhealthy" ]; then
          echo "has_healthcheck"
        else
          echo "no_healthcheck"
        fi
      register: healthcheck_type
      delegate_to: "{{ delegate_host }}"
      changed_when: false

    - name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ delegate_host }} | {{ app_name }} | HealthCheck | Wait for container with healthcheck"
      shell: "docker inspect --format='{{ '{{' }}.State.Health.Status{{ '}}' }}' {{ app_name }}"
      register: health_status
      until: health_status.stdout | trim == "healthy"
      retries: "{{ retries | default(30) }}"
      delay: "{{ interval | default(5) }}"
      delegate_to: "{{ delegate_host }}"
      when: (healthcheck_type.stdout | default('') | trim) == "has_healthcheck"

    - name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ delegate_host }} | {{ app_name }} | HealthCheck | Wait for one-time container or service"
      shell: |
        if docker inspect {{ app_name }} >/dev/null 2>&1; then
          status=$(docker inspect --format='{{ '{{' }}.State.Status{{ '}}' }}' {{ app_name }})
          exit_code=$(docker inspect --format='{{ '{{' }}.State.ExitCode{{ '}}' }}' {{ app_name }})
          if [ "$status" = "running" ] || { [ "$status" = "exited" ] && [ "$exit_code" -eq 0 ]; }; then
            echo "success"
          else
            echo "waiting"
          fi
        else
          echo "waiting"
        fi
      register: container_status
      until: container_status.stdout | trim == "success"
      retries: "{{ retries | default(30) }}"
      delay: "{{ interval | default(5) }}"
      delegate_to: "{{ delegate_host }}"
      when: (healthcheck_type.stdout | default('') | trim) == "no_healthcheck"

    when: >
      not (container_initial_status.stdout | default('')).startswith("already_exited_success") and
      not (container_initial_status.stdout | default('')).startswith("already_exited_failed")

  when: app_type | default('docker') == 'docker'

# ==========================================
# Phase: CMD/Binary Health Check Logic
# ==========================================
- block:
  - name: "{{ lookup('pipe', 'date +%H:%M:%S') }} | {{ delegate_host }} | {{ app_name }} | HealthCheck | Verify command"
    shell: "{{ current_app.health_cmd | default(current_app.command) }}"
    delegate_to: "{{ delegate_host }}"
    register: health_cmd_result
    until: health_cmd_result.rc == 0
    retries: "{{ retries | default(5) }}"
    delay: "{{ interval | default(2) }}"
    changed_when: false

  when: app_type | default('docker') == 'cmd'