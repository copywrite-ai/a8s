app_definitions:
  # 1. 基础服务: 外部数据库 (带健康检查)
  db_mysql_demo:
    image: "alpine:latest@8764bc580cf9"
    raw_command: |
      docker run -d --name db_mysql_demo alpine:latest tail -f /dev/null

  # 2. 核心服务: Elasticsearch (BigData 场景)
  es_app:
    image: "elasticsearch:7.17.23@5113bca13f4f"
    ports:
      - "9200:9200"
    raw_command: |
      docker run -d --name es_app \
      -p 9200:9200 \
      -e "discovery.type=single-node" \
      -e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
      --health-cmd="curl -s http://localhost:9200/_cluster/health | grep -qE 'green|yellow' || exit 1" \
      --health-interval=10s \
      --health-retries=20 \
      elasticsearch:7.17.23

  # 3. 后置任务: ES 索引创建 (Network Host 模式)
  es_index_task:
    image: "alpine:latest@8764bc580cf9"
    raw_command: |
      docker run --name es_index_task --network host alpine:latest sh -c "
        apk add --no-cache curl && \
        echo 'Waiting for ES port...' && \
        until curl -s http://localhost:9200; do sleep 2; done && \
        echo 'Creating index...' && \
        curl -X PUT http://localhost:9200/test_index?pretty && \
        echo 'Index created successfully'
      "

  # 4. 业务应用: 复杂初始化脚本 (Script Mode)
  app_complex_script:
    image: "nginx:alpine@cbad6347cca2"
    raw_command: |
      docker run -d --name app_complex_script -p 8085:80 nginx:alpine
      # 执行多行初始化脚本
      docker exec app_complex_script sh -c "echo 'Production Content' > /usr/share/nginx/html/index.html"
      docker exec app_complex_script sh -c "mkdir -p /tmp/ready"

  # 5. 业务应用: 链式嵌套续行 (Extremely Complex Mode)
  app_extremely_complex:
    image: "nginx:alpine@cbad6347cca2"
    raw_command: |
      docker run -d \
        --name app_extremely_complex \
        -p 8087:80 \
        nginx:alpine && \
      docker exec app_extremely_complex \
        sh -c "echo 'Nested Chained Success' > /usr/share/nginx/html/index.html" && \
      docker exec app_extremely_complex \
        ls -l /usr/share/nginx/html/

  # 6. 一次性任务: 数据迁移 (One-time Job)
  job_data_migration:
    image: "alpine:latest@8764bc580cf9"
    raw_command: |
      docker run --name job_data_migration alpine:latest sh -c "echo 'Migration starting...'; sleep 1; exit 0"

  # 7. SRE 验证: 命令探测 (Cmd Type)
  sre_api_warmer:
    app_type: cmd
    command: "curl -s -f http://localhost:8085"
    healthcheck:
      type: exit_code
      retries: 10
      interval: 3